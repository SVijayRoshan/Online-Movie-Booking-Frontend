import{c as D,r as d,j as e,a as f,b as P,u as $,d as M,e as R,g as T,f as B}from"./index-YhsNIgvP.js";import{u as z,H as v}from"./Header-CL76FjJX.js";import{u as I}from"./useMutation-CLwU4-RE.js";import{B as b,a as j}from"./button-Duyd6bEY.js";import{C as V}from"./clock-NVaRpnqF.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const q=D("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]),N=d.memo(({seat:t,isSelected:a,onSelect:l})=>{const i=()=>{(t.state==="available"||a)&&l(t.id)},c=o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),i())},r=()=>a?"default":t.state==="booked"?"secondary":t.state==="locked"?"outline":"ghost",n=()=>`Seat ${t.row}${t.number}, ${t.state}${a?", selected":""}`;return e.jsxs(b,{variant:r(),size:"sm",className:f("min-w-[44px] min-h-[44px] p-2 text-xs font-medium",t.state==="booked"&&"cursor-not-allowed opacity-50",t.state==="locked"&&"cursor-not-allowed opacity-70 border-chart-5",a&&"ring-2 ring-primary"),onClick:i,onKeyDown:c,disabled:t.state==="booked"||t.state==="locked","aria-label":n(),"aria-pressed":a,"data-testid":`seat-${t.id}`,children:[t.row,t.number]})});N.displayName="SeatButton";function F({seats:t,selectedSeats:a,onSeatSelect:l}){const i=d.useMemo(()=>{const r=new Map;return t.forEach(n=>{r.has(n.row)||r.set(n.row,[]),r.get(n.row).push(n)}),Array.from(r.values()).forEach(n=>{n.sort((o,h)=>o.number-h.number)}),r},[t]),c=d.useCallback(r=>{l(r)},[l]);return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center py-4 border-b-4 border-muted rounded-lg mb-8",children:e.jsx("p",{className:"text-sm font-semibold text-muted-foreground tracking-wider",children:"SCREEN"})}),e.jsx("div",{className:"space-y-2 max-w-4xl mx-auto",children:Array.from(i.entries()).map(([r,n])=>e.jsxs("div",{className:"flex items-center gap-2 justify-center",children:[e.jsx("div",{className:"w-8 text-center font-semibold text-muted-foreground text-sm",children:r}),e.jsx("div",{className:"flex gap-1 flex-wrap justify-center",children:n.map(o=>e.jsx(N,{seat:o,isSelected:a.includes(o.id),onSelect:c},o.id))})]},r))})]})}function K(){return e.jsxs("div",{className:"flex flex-wrap gap-4 justify-center items-center p-4 bg-card rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-6 h-6 bg-primary rounded-md"}),e.jsx("span",{className:"text-sm",children:"Selected"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-6 h-6 bg-muted rounded-md"}),e.jsx("span",{className:"text-sm",children:"Available"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-6 h-6 bg-secondary rounded-md opacity-50"}),e.jsx("span",{className:"text-sm",children:"Booked"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-6 h-6 border-2 border-chart-5 rounded-md opacity-70"}),e.jsx("span",{className:"text-sm",children:"Locked"})]})]})}const H=P("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),k=d.forwardRef(({className:t,variant:a,...l},i)=>e.jsx("div",{ref:i,role:"alert",className:f(H({variant:a}),t),...l}));k.displayName="Alert";const G=d.forwardRef(({className:t,...a},l)=>e.jsx("h5",{ref:l,className:f("mb-1 font-medium leading-none tracking-tight",t),...a}));G.displayName="AlertTitle";const w=d.forwardRef(({className:t,...a},l)=>e.jsx("div",{ref:l,className:f("text-sm [&_p]:leading-relaxed",t),...a}));w.displayName="AlertDescription";function W(){const{showId:t}=$(),[,a]=M(),{isAuthenticated:l}=R(),{toast:i}=T(),[c,r]=d.useState([]),[n,o]=d.useState(null),[h,y]=d.useState(0),{data:u,isLoading:S,refetch:g}=z({queryKey:["/api/shows",t],queryFn:()=>j.getShow(t),enabled:!!t,refetchInterval:5e3}),p=I({mutationFn:s=>j.lockSeats(t,{seatIds:s,holdSeconds:300}),onSuccess:s=>{s.failedSeats.length>0?(i({title:"Some seats could not be locked",description:`Failed to lock: ${s.failedSeats.join(", ")}. Please select other seats.`,variant:"destructive"}),r(m=>m.filter(x=>!s.failedSeats.includes(x))),g()):(o(new Date(s.expiresAt)),a(`/checkout?showId=${t}&lockToken=${s.lockToken}&seats=${s.lockedSeats.join(",")}`))},onError:s=>{i({title:"Lock failed",description:s.message,variant:"destructive"})}});d.useEffect(()=>{if(!n)return;const s=setInterval(()=>{const m=Math.max(0,Math.floor((n.getTime()-Date.now())/1e3));y(m),m===0&&(i({title:"Lock expired",description:"Please select your seats again",variant:"destructive"}),o(null),r([]),g())},1e3);return()=>clearInterval(s)},[n,i,g]);const L=d.useCallback(s=>{r(m=>m.includes(s)?m.filter(x=>x!==s):[...m,s])},[]),A=()=>{if(!l){i({title:"Authentication required",description:"Please login to continue"}),a("/login");return}if(c.length===0){i({title:"No seats selected",description:"Please select at least one seat",variant:"destructive"});return}p.mutate(c)},E=c.reduce((s,m)=>{const x=u==null?void 0:u.seatsLayout.find(C=>C.id===m);return s+((x==null?void 0:x.price)||0)},0);return S?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(v,{}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8 animate-pulse",children:[e.jsx("div",{className:"h-8 bg-muted rounded w-1/3 mb-8"}),e.jsx("div",{className:"h-64 bg-muted rounded"})]})]}):u?e.jsxs("div",{className:"min-h-screen bg-background pb-32",children:[e.jsx(v,{}),e.jsxs("main",{className:"max-w-7xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2","data-testid":"text-show-info",children:u.theatre}),e.jsxs("p",{className:"text-muted-foreground",children:[new Date(u.date).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})," â€¢ ",u.time]})]}),n&&h>0&&e.jsxs(k,{className:"mb-6",children:[e.jsx(V,{className:"h-4 w-4"}),e.jsxs(w,{children:["Seats locked. Time remaining: ",Math.floor(h/60),":",(h%60).toString().padStart(2,"0")]})]}),e.jsx(K,{}),e.jsx("div",{className:"my-8",children:e.jsx(F,{seats:u.seatsLayout,selectedSeats:c,onSeatSelect:L})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-card border-t p-4 z-40",children:e.jsxs("div",{className:"max-w-7xl mx-auto flex items-center justify-between gap-4 flex-wrap",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:[c.length," seat",c.length!==1?"s":""," selected"]}),e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-total-price",children:B(E)})]}),e.jsxs(b,{size:"lg",onClick:A,disabled:c.length===0||p.isPending,"data-testid":"button-lock-seats",children:[e.jsx(q,{className:"w-4 h-4 mr-2"}),p.isPending?"Locking...":"Lock Seats & Continue"]})]})})]})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(v,{}),e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-12 text-center",children:e.jsx("h2",{className:"text-2xl font-bold",children:"Show not found"})})]})}export{W as default};
